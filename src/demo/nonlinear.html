<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>nonlinear</title>
		<style type="text/css">*{padding:0; margin:0;}</style>
		<script type="text/javascript">
			var dataset = {
				"frameWidth":800,
				"frameHeight":600,
				"lensX":0.5,"lensY":0.5,
				"curvature":0,
				"magnification":1,
				objects: [{"type":"line","x":0.1268882175226586,"y":0.05287009063444107,"x2":0.1268882175226586,"y2":0.8585095669687814,"color":"#5555aa"},{"type":"line","x":0.1772406847935549,"y":0.05287009063444107,"x2":0.1772406847935549,"y2":0.8585095669687814,"color":"#5555aa"},{"type":"line","x":0.22759315206445116,"y":0.05287009063444107,"x2":0.22759315206445116,"y2":0.8585095669687814,"color":"#5555aa"},{"type":"line","x":0.27794561933534745,"y":0.05287009063444107,"x2":0.27794561933534745,"y2":0.8585095669687814,"color":"#5555aa"},{"type":"line","x":0.3282980866062437,"y":0.05287009063444107,"x2":0.3282980866062437,"y2":0.8585095669687814,"color":"#5555aa"},{"type":"line","x":0.37865055387714,"y":0.05287009063444107,"x2":0.37865055387714,"y2":0.8585095669687814,"color":"#5555aa"},{"type":"line","x":0.42900302114803623,"y":0.05287009063444107,"x2":0.42900302114803623,"y2":0.8585095669687814,"color":"#5555aa"},{"type":"line","x":0.47935548841893255,"y":0.05287009063444107,"x2":0.47935548841893255,"y2":0.8585095669687814,"color":"#5555aa"},{"type":"line","x":0.5297079556898288,"y":0.05287009063444107,"x2":0.5297079556898288,"y2":0.8585095669687814,"color":"#5555aa"},{"type":"line","x":0.5800604229607251,"y":0.05287009063444107,"x2":0.5800604229607251,"y2":0.8585095669687814,"color":"#5555aa"},{"type":"line","x":0.6304128902316214,"y":0.05287009063444107,"x2":0.6304128902316214,"y2":0.8585095669687814,"color":"#5555aa"},{"type":"line","x":0.6807653575025177,"y":0.05287009063444107,"x2":0.6807653575025177,"y2":0.8585095669687814,"color":"#5555aa"},{"type":"line","x":0.7311178247734139,"y":0.05287009063444107,"x2":0.7311178247734139,"y2":0.8585095669687814,"color":"#5555aa"},{"type":"line","x":0.7814702920443102,"y":0.05287009063444107,"x2":0.7814702920443102,"y2":0.8585095669687814,"color":"#5555aa"},{"type":"line","x":0.8318227593152064,"y":0.05287009063444107,"x2":0.8318227593152064,"y2":0.8585095669687814,"color":"#5555aa"},{"type":"line","x":0.8821752265861027,"y":0.05287009063444107,"x2":0.8821752265861027,"y2":0.8585095669687814,"color":"#5555aa"},{"type":"line","x":0.932527693856999,"y":0.05287009063444107,"x2":0.932527693856999,"y2":0.8585095669687814,"color":"#5555aa"},{"type":"line","x":0.1268882175226586,"y":0.05287009063444107,"x2":0.932527693856999,"y2":0.05287009063444107,"color":"#5555aa"},{"type":"line","x":0.1268882175226586,"y":0.12000671366230277,"x2":0.932527693856999,"y2":0.12000671366230277,"color":"#5555aa"},{"type":"line","x":0.1268882175226586,"y":0.18714333669016447,"x2":0.932527693856999,"y2":0.18714333669016447,"color":"#5555aa"},{"type":"line","x":0.1268882175226586,"y":0.2542799597180262,"x2":0.932527693856999,"y2":0.2542799597180262,"color":"#5555aa"},{"type":"line","x":0.1268882175226586,"y":0.32141658274588786,"x2":0.932527693856999,"y2":0.32141658274588786,"color":"#5555aa"},{"type":"line","x":0.1268882175226586,"y":0.3885532057737496,"x2":0.932527693856999,"y2":0.3885532057737496,"color":"#5555aa"},{"type":"line","x":0.1268882175226586,"y":0.4556898288016113,"x2":0.932527693856999,"y2":0.4556898288016113,"color":"#5555aa"},{"type":"line","x":0.1268882175226586,"y":0.522826451829473,"x2":0.932527693856999,"y2":0.522826451829473,"color":"#5555aa"},{"type":"line","x":0.1268882175226586,"y":0.5899630748573347,"x2":0.932527693856999,"y2":0.5899630748573347,"color":"#5555aa"},{"type":"line","x":0.1268882175226586,"y":0.6570996978851964,"x2":0.932527693856999,"y2":0.6570996978851964,"color":"#5555aa"},{"type":"line","x":0.1268882175226586,"y":0.7242363209130581,"x2":0.932527693856999,"y2":0.7242363209130581,"color":"#5555aa"},{"type":"line","x":0.1268882175226586,"y":0.7913729439409197,"x2":0.932527693856999,"y2":0.7913729439409197,"color":"#5555aa"},{"type":"line","x":0.1268882175226586,"y":0.8585095669687814,"x2":0.932527693856999,"y2":0.8585095669687814,"color":"#5555aa"},{"type":"circle","x":0.8006042296072508,"y":0.4288351795904666,"rx":0.06646525679758308,"ry":0.08862034239677745,"color":"#C399FF"},{"type":"spline","points":[0.2638469284994965,0.5156092648539778,0.39778449144008055,0.6391406512252433,0.41289023162134947,0.815038603558241],"color":"#99D2FF","thickness":3,"closed":true},{"type":"line","x":0.3474320241691843,"y":0.4986572675394428,"x2":0.28700906344410876,"y2":0.7108089963074857,"color":"#99BBFF"},{"type":"line","x":0.23363544813695872,"y":0.6691842900302115,"x2":0.05639476334340383,"y2":0.8168848606915072,"color":"#99B9FF"},{"type":"circle","x":0.14803625377643503,"y":0.6705270224907687,"rx":0.017791205102383353,"ry":0.0237216068031778,"color":"#FFA199"},{"type":"rectangle","x":0.6646525679758308,"y":0.5349110439744881,"w":0.09164149043303121,"h":0.10339039946290701,"color":"#FFBB99"},{"type":"spline","points":[0.6918429003021148,0.42967438737831487,0.6636455186304129,0.5196374622356495,0.6364551863041289,0.5612621685129238,0.6042296072507553,0.6216851292379993,0.7099697885196374,0.729103726082578,0.7774420946626385,0.7935548841893253,0.7744209466263847,0.8257804632426989,0.7613293051359517,0.792212151728768,0.7421953675730111,0.8512923799932863,0.7653575025176234,0.8660624370594159,0.7814702920443102,0.8862034239677744,0.8831822759315207,0.9439409197717354],"color":"#F4FF99","thickness":3,"closed":false},{"type":"rectangle","x":0.33131923464249746,"y":0.4100369251426653,"w":0.2094662638469285,"h":0.17186975495132595,"color":"#B499FF"},{"type":"circle","x":0.2326283987915408,"y":0.5671366230278617,"rx":0.022155085599194362,"ry":0.029540114132259147,"color":"#99FFEA"},{"type":"line","x":0.16012084592145015,"y":0.46240349110439743,"x2":0.38368580060422963,"y2":0.7000671366230279,"color":"#99ADFF"},{"type":"rectangle","x":0.5961732124874118,"y":0.3079892581403155,"w":0.1067472306143001,"h":0.1772406847935549,"color":"#99FFA8"},{"type":"rectangle","x":0.1581067472306143,"y":0.2945619335347432,"w":0.1067472306143001,"h":0.06176569318563276,"color":"#B2FF99"},{"type":"rectangle","x":0.8126888217522659,"y":0.12403491104397447,"w":0.07049345417925479,"h":0.23632091305807318,"color":"#FF9C99"},{"type":"line","x":0.552870090634441,"y":0.6826116146357838,"x2":0.7945619335347432,"y2":0.6987244041624706,"color":"#FFA199"},{"type":"circle","x":0.4511581067472306,"y":0.6315877811346089,"rx":0.016448472641826115,"ry":0.021931296855768154,"color":"#99D1FF"},{"type":"line","x":0.6243705941591138,"y":0.7604900973481034,"x2":0.7200402819738168,"y2":0.861195031889896,"color":"#99FFFD"},{"type":"spline","points":[0.7180261832829808,0.7787848271231957,0.6817724068479355,0.797583081570997,0.7280966767371602,0.8324941255454851,0.850956696878147,0.9882510909701242,0.8700906344410876,1.1547499160792212],"color":"#F399FF","thickness":2,"closed":true},{"type":"point","x":0.2457200402819738,"y":0.05958375293722724,"color":"#FFDE99"},{"type":"circle","x":0.13997985901309165,"y":0.6383014434373951,"rx":0.027861698556562606,"ry":0.03714893140875014,"color":"#CD99FF"},{"type":"rectangle","x":0.5105740181268882,"y":0.46643168848606914,"w":0.2588116817724068,"h":0.10876132930513595,"color":"#99FFD1"},{"type":"spline","points":[0.7995971802618328,0.5478348439073515,0.8157099697885196,0.5948304800268547,0.8207452165156093,0.6002014098690835,0.8187311178247734,0.643168848606915],"color":"#E7FF99","thickness":3,"closed":false},{"type":"line","x":0.24169184290030213,"y":0.7108089963074857,"x2":0.23162134944612287,"y2":0.947129909365559,"color":"#FFE299"},{"type":"line","x":0.5871097683786506,"y":0.40735146022155083,"x2":0.34843907351460224,"y2":0.5093991272239007,"color":"#FFF499"},{"type":"spline","points":[0.36253776435045315,0.18126888217522658,0.3826787512588117,0.2645182947297751,0.526686807653575,0.3531386371265525],"color":"#99AFFF","thickness":3,"closed":false},{"type":"spline","points":[0.486404833836858,0.03491104397448808,0.5891238670694864,0.18261161463578382,0.6616314199395771,0.2645182947297751],"color":"#FFA499","thickness":2,"closed":false},{"type":"line","x":0.39677744209466265,"y":0.5684793554884189,"x2":0.2366565961732125,"y2":0.75243370258476,"color":"#A199FF"},{"type":"line","x":0.15911379657603222,"y":0.16565961732124873,"x2":0,"y2":0.3657267539442766,"color":"#FFF399"},{"type":"point","x":0.7391742195367573,"y":0.5617656931856327,"color":"#E5FF99"},{"type":"circle","x":0.6132930513595166,"y":0.6235313863712655,"rx":0.05639476334340383,"ry":0.0751930177912051,"color":"#FF9999"},{"type":"point","x":0.19637462235649547,"y":0.43017791205102385,"color":"#CF99FF"},{"type":"point","x":0.3595166163141994,"y":0.4530043638804968,"color":"#99D9FF"},{"type":"rectangle","x":0.2366565961732125,"y":0.5993622020812354,"w":0.20443101711983888,"h":0.1973816717019134,"color":"#FFBC99"},{"type":"rectangle","x":0.8710976837865055,"y":0.2314535078885532,"w":0.12890231621349446,"h":0.13695871097683787,"color":"#AB99FF"},{"type":"point","x":0.8318227593152064,"y":0.6369587109768379,"color":"#99FFCA"},{"type":"spline","points":[0.756294058408862,0.4498153742866734,0.7411883182275931,0.4739845585767036,0.7472306143001007,0.5008392077878483,0.8066465256797583,0.5357502517623364,0.8207452165156093,0.5290365894595502,0.8006042296072508,0.5182947297750923,0.8429003021148036,0.5357502517623364,0.8580060422960725,0.56797583081571],"color":"#99FFB4","thickness":3,"closed":false},{"type":"rectangle","x":0.14300100704934543,"y":0.38452500839207787,"w":0.22860020140986909,"h":0.18529707955689828,"color":"#FFC699"},{"type":"point","x":0.2598187311178248,"y":0.8222557905337362,"color":"#99FFA4"},{"type":"rectangle","x":0.5327291037260826,"y":0.5308828465928164,"w":0.10976837865055387,"h":0.15709969788519637,"color":"#FFE899"},{"type":"rectangle","x":0.4350453172205438,"y":0.5537092984222893,"w":0.1268882175226586,"h":0.22692178583417255,"color":"#FFDD99"},{"type":"line","x":0.2598187311178248,"y":0.37512588116817724,"x2":0.0473313192346425,"y2":0.6369587109768379,"color":"#99FFEC"},{"type":"circle","x":0.8731117824773413,"y":0.3455857670359181,"rx":0.02450486740516952,"ry":0.032673156540226025,"color":"#99FFF9"},{"type":"spline","points":[0.4169184290030212,0.36925142665323935,0.4229607250755287,0.418932527693857,0.5357502517623364,0.5370929842228936,0.5850956696878147,0.5169519973145351],"color":"#99A9FF","thickness":3,"closed":false},{"type":"circle","x":0.6102719033232629,"y":0.43152064451158106,"rx":0.08492782813024505,"ry":0.11323710417366006,"color":"#FFE299"},{"type":"spline","points":[0.38872104733131924,0.7599865726753944,0.3766364551863041,0.7250755287009063,0.3796576032225579,0.8083249412554548,0.3766364551863041,0.9050016784155757,0.4300100704934542,0.9801946962067808,0.4702920443101712,1.0083920778784827],"color":"#FFFD99","thickness":3,"closed":false},{"type":"point","x":0.8469284994964753,"y":0.7658610271903323,"color":"#FFCA99"},{"type":"line","x":0.878147029204431,"y":0.27710641154749915,"x2":0.8942598187311178,"y2":0.3079892581403155,"color":"#BA99FF"},{"type":"spline","points":[0.5770392749244713,0.6915072171869755,0.608257804632427,0.8405505203088285,0.5931520644511581,0.9963074857334676,0.6012084592145015,1.130580731789191,0.6777442094662638,1.0835850956696877,0.6908358509566969,1.1614635783820073,0.7210473313192346,1.2957368244377307],"color":"#A6FF99","thickness":3,"closed":false},{"type":"point","x":0.32225579053373615,"y":0.68932527693857,"color":"#FFF699"},{"type":"line","x":0.28700906344410876,"y":0.4798590130916415,"x2":0.3041289023162135,"y2":0.7497482376636455,"color":"#FFCF99"},{"type":"point","x":0.6968781470292045,"y":0.6289023162134945,"color":"#FD99FF"},{"type":"line","x":0.256797583081571,"y":0.43689157435381,"x2":0.48036253776435045,"y2":0.46643168848606914,"color":"#D699FF"},{"type":"line","x":0.5448136958710977,"y":0.6570996978851964,"x2":0.56797583081571,"y2":0.7175226586102719,"color":"#F9FF99"},{"type":"circle","x":0.32326283987915405,"y":0.41540785498489424,"rx":0.06008727760993622,"ry":0.08011637014658163,"color":"#99FFBB"},{"type":"circle","x":0.1510574018126888,"y":0.1750587445451494,"rx":0.06243705941591138,"ry":0.08324941255454851,"color":"#FFBB99"},{"type":"point","x":0.3041289023162135,"y":0.5832494125545485,"color":"#CCFF99"},{"type":"rectangle","x":0.32729103726082576,"y":0.28382007385028535,"w":0.010070493454179255,"h":0.09936220208123532,"color":"#D2FF99"},{"type":"point","x":0.3826787512588117,"y":0.37378314870762,"color":"#C199FF"},{"type":"spline","points":[0.7119838872104733,0.5800604229607251,0.729103726082578,0.5894595501846257,0.7079556898288016,0.6337697213830145,0.7150050352467271,0.625713326619671,0.7129909365558912,0.6377979187646862,0.7150050352467271,0.6606243705941591,0.75730110775428,0.6633098355152736,0.8086606243705942,0.6619671030547164],"color":"#AD99FF","thickness":2,"closed":false},{"type":"spline","points":[0.6878147029204431,0.5115810674723061,0.6827794561933535,0.5760322255790534,0.7784491440080564,0.5532057737495804,0.7482376636455186,0.5290365894595502,0.7683786505538771,0.5558912386706949,0.8439073514602216,0.625713326619671],"color":"#99FFA6","thickness":4,"closed":false},{"type":"circle","x":0.38872104733131924,"y":0.8021148036253777,"rx":0.035582410204766705,"ry":0.0474432136063556,"color":"#D6FF99"}]
			}
			onload = function(){
				function rescale(context, width, height){
					var ratio = window.devicePixelRatio || 1;
					context.canvas.width = width * ratio;
					context.canvas.height = height * ratio;
					context.canvas.style.width = width + "px";
					context.canvas.style.height = height + "px";
					context.scale(ratio, ratio);
				}

				
				var surface = function(canvas, width, height){
					var width = Math.max(width | 0, 300),
						height = Math.max(height | 0, 150);
					var canvas = canvas,
						context = canvas.getContext("2d");
					var config = {
						chart: {
							width: width,
							height: height,
							radius: 180,
							margin: {
								left: 80,
								right: 50,
								bottom: 10,
								top: 10
							},
							lineColor: ["#a6d854", "#72caed", "#95A5A6"],
							fillColor: ["#F38630", "#a6d854", "#E0E4CC"]
						}
					};
					//rescale(context, width, height);

					var series = [];
					var canvas = context.canvas;
					var cx = width / 2,
						cy = height / 2;
					var dragging = false;

					var round = function(a){ return a + 0.5; }
					function moveTo(canvas, x, y){
						var box = canvas.getBoundingClientRect();
						//console.log(box, width, height);
						return {
							x: (x - box.left) * (width / box.width),
							y: (y - box.top) * (height / box.height)
						};
					}

					function surface(){

					}
					surface.data = function(d){
						series = d;
						return surface;
					};
					surface.draw = function(){
						draw();
					};
					surface.redraw = function(){
						this.clear();
						draw();
					};
					surface.clear = function(){
						context.clearRect(0, 0, width, height);
					};
					
					var view = {
						curvature: 0.7,
						frameHeight: 600,
						frameWidth: 800,
						lensR: 0.19522860933439357,
						lensX: 0.23499832520496328,
						lensY: 0.15999785120636806,
						magnification: 2.5,
						xMax: 862.9444444444445,
						xMin: -73.94444444444449,
						yMax: 630,
						yMin: -72.66666666666667
					};
					//draw
					function project(x, y, view){
						var dx = x - view.lensX,
							dy = y - view.lensY;
						var angle = Math.atan2(dy, dx),
							plane = Math.sqrt(dx * dx + dy * dy);
						var s = view.magnification * view.lensR * Math.atan(plane / view.lensR);
						var px = view.lensX + s * Math.cos(angle),
							py = view.lensY + s * Math.sin(angle);
						return {
							x: view.frameWidth * px,
							y: view.frameHeight * py
						};
					}
					function lineTo(x1, y1, x2, y2, view){
						var p0 = project(x1, y1, view),
							p1 = project(x2, y2, view);
						var cp = project((x1 + x2) / 2, (y1 + y2) / 2, view);
						context.quadraticCurveTo(
							2 * cp.x - p0.x / 2 - p1.x / 2,
							2 * cp.y - p0.y / 2 - p1.y / 2,
							p1.x,
							p1.y
						);
					}
					function draw(){
						console.log(view);
						surface.clear();
						var curvature = Math.sqrt(Math.abs(view.curvature)),
							epsilon = 0.01;
						view.xmin = dataset.xMin;
						view.xmax = dataset.xMax;
						view.ymin = dataset.yMin;
						view.ymax = dataset.yMax;
						view.lensR = (1 / curvature) - 1;//-> 0 => plane, -> 1 => tiny sphere

						for(var i = 0; i < dataset.objects.length; i++){
							var o = dataset.objects[i],
								p = project(o.x, o.y, view);
							if(o.type === "line"){
								context.lineWidth = 1.5;
								context.strokeStyle = o.color;
								context.beginPath();
								context.moveTo(p.x, p.y);
								lineTo(o.x, o.y, o.x2, o.y2, view);
								context.stroke();
								context.closePath();
							}
						}
					}
					//bind mouse move
					canvas.onmousedown = function(e){
						dragging = true;
					};
					canvas.onmousemove = function(e){
						var box = moveTo(this, e.clientX, e.clientY);
						if(dragging){
							var lensX = view.lensX,
								lensY = view.lensY,
								magnification = view.magnification,
								curvature = view.curvature;
							var f = 2 / 30;
							view.lensX = f * lensX + (1 - f);
							view.lensY = f * lensY + (1 - f);
							view.magnification = f * magnification + (1 - f);
							view.curvature = f * curvature + (1 - f);
							draw();
						}
					};
					canvas.onmouseup = function(){
						//canvas.onmousemove = null;
						//canvas.onmousedown = null;
						dragging = false;
					};
					return surface;
				}
				var canvas = document.getElementById("vis"),
					context = canvas.getContext("2d");
				var series = [/*{
					name: "JAVA",
					data: [1.8, 2.3, 8.2, 1.7, 4.5, 8.2, 1.7, 4.5],
					color: "#F38630"
				}*/];

				surface(canvas, canvas.width, canvas.height).data(series).draw();
			};
		</script>
	</head>
	<body>
		<canvas id="vis" width="650" height="450"></canvas>
	</body>
</html>